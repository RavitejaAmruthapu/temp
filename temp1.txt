apiVersion: v1
kind: Template
labels:
  template: deployment-image-build
parameters:
- name: LS_BRANCH_REF
  required: true
- name: LS_BUILD_ID
  required: true
- name: LS_BUILD_NAME
  required: true
- name: LS_BUILD_URL
  required: true
- name: LS_BUILD_VERSION
  required: true
- name: LS_COMMIT_ID
  required: true
- name: LS_DOCKER_REGISTRY
  required: true
- name: LS_EXTRA_LABELS
  required: false
  value: ''
- name: LS_GIT_URL
  required: true
- name: LS_LOKI_BUILD_ID
  required: true
- name: LS_LOKI_URL
  required: true
- name: LS_OUTPUT_IMAGE
  required: true
- name: LS_PIPELINE_NAME
  required: true
- name: LS_PROJECT_CSI_ID
  required: true
objects:
- apiVersion: build.openshift.io/v1
  kind: BuildConfig
  metadata:
    annotations:
      description: Defines how to build the application
    labels:
      lightspeed-pipeline: "${LS_PIPELINE_NAME}"
      lightspeed-build-id: "${LS_BUILD_ID}"
    name: ${LS_BUILD_NAME}
  spec:
    completionDeadlineSeconds: 1800
    failedBuildsHistoryLimit: 5
    nodeSelector: null
    output:
      pushSecret:
        name: artifactory-docker-push
      to:
        kind: DockerImage
        name: "${LS_DOCKER_REGISTRY}/${LS_OUTPUT_IMAGE}"
      imageLabels:
      - name: com.citi.lightspeed.build.commit.id
        value: "${LS_COMMIT_ID}"
      - name: com.citi.lightspeed.build.id
        value: "${LS_BUILD_ID}"
      - name: com.citi.lightspeed.build.pipeline.name
        value: "${LS_PIPELINE_NAME}"
      - name: com.citi.lightspeed.build.source-location
        value: "${LS_GIT_URL}"
      - name: com.citi.lightspeed.build.url
        value: "${LS_BUILD_URL}"
      - name: com.citi.lightspeed.build.version
        value: "${LS_BUILD_VERSION}"
      - name: com.citi.lightspeed.csi.id
        value: "${LS_PROJECT_CSI_ID}"
      - name: com.citi.lightspeed.loki.build.id
        value: "${LS_LOKI_BUILD_ID}"
      - name: com.citi.lightspeed.loki.url
        value: "${LS_LOKI_URL}"
    postCommit: {}
    resources:
      limits:
        memory: 4Gi
    runPolicy: Serial
    source:
      binary: {}
      type: Binary
    strategy:
      sourceStrategy:
        from:
          kind: DockerImage
          name: docker-icg-prod-local.artifactrepository.citigroup.net/icg-msst-infra-171981/deployer-s2i:latest
        env:
        - name: APP_NAME
          value: "${LS_PIPELINE_NAME}"
        - name: APP_VERSION
          value: "${LS_BUILD_VERSION}"
        - name: BRANCH_REF
          value: "${LS_BRANCH_REF}"
        - name: CSI_ID
          value: "${LS_PROJECT_CSI_ID}"
        - name: DOCKER_REGISTRY
          value: "${LS_DOCKER_REGISTRY}"
        - name: EXTRA_LABELS
          value: "${LS_EXTRA_LABELS}"
        - name: IMAGE_NAME
          value: "${LS_PIPELINE_NAME}"
        forcePull: true
        pullSecret:
          name: citi-docker
      type: Source
    successfulBuildsHistoryLimit: 5
    triggers: []
